<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>LADDER</title><meta name=description content="Ladder@本文关于 kubenates workshop
"><meta name=author content="iguangzhengli@gmail.com"><link rel=canonical href=https://guangzhengli.github.io/zh/blog/kubenates-workshop/><meta name=google-site-verification content="RL6kP6-6yjRPyYGLeqBQ2JIX6QQAz7A6gHZb7bHlZnU"><meta property="og:title" content="Kubenates workshop"><meta property="og:description" content="本文关于 kubenates workshop
"><meta property="og:type" content="article"><meta property="og:url" content="https://guangzhengli.github.io/zh/blog/kubenates-workshop/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-07-18T20:29:08+00:00"><meta property="article:modified_time" content="2021-07-18T20:29:08+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubenates workshop"><meta name=twitter:description content="本文关于 kubenates workshop
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://guangzhengli.github.io/zh/blog/"},{"@type":"ListItem","position":2,"name":"Kubenates workshop","item":"https://guangzhengli.github.io/zh/blog/kubenates-workshop/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubenates workshop","name":"Kubenates workshop","description":"本文关于 kubenates workshop ","keywords":["CloudNative","kubenates","container","helm"],"articleBody":"本文关于 kubenates workshop 准备工作 本地环境是 MacOS 11.6.2 Intel 版本，教程也是本地环境。windows 或 linux 环境的小伙伴需要自行安装 docker 和 minikube。\n安装 docker 因为 docker desktop 各种协议和法律问题，已经不建议大家直接安装 desktop 使用，建议只安装 CLI。注意：如果本地已经安装了 docker desktop，那么可以忽略这一步，下一步也可以简化。\n# Install Docker CLI brew install docker brew install docker-compose 安装 minikube minikube 用于在本地环境中运行 Kubernetes 集群。但它也运行一个可用于运行容器的 docker 守护进程。在 macOS 上，minikube 运行在很多虚拟化技术上，可以选择hyperkit，这里因为我本地之前已经安装过 virtualbox (brew install –cask virtualbox)，所以我用的是 virtualbox 虚拟化技术。如果你本地之前已经安装了 docker desktop 的话，可以不需要下载 hyperkit 或者 virtualbox。\n# Install hyperkit and minikube (check which vm-driver to use, if install docker desktop already, you can just use vm-driver=docker instead of install hyperkiy) brew install hyperkit brew install minikube # Start minikube minikube start --vm-driver hyperkit --container-runtime=docker # minikube start --vm-driver virtualbox --container-runtime=docker # minikube start --vm-driver docker --container-runtime=docker # Tell Docker CLI to talk to minikube's VM eval $(minikube docker-env) # Save IP to a hostname echo \"`minikube ip` docker.local\" | sudo tee -a /etc/hosts \u003e /dev/null # Test docker run hello-world 注意：如果本地已经安装了 docker desktop，那么可以使用 minikube start –vm-driver docker –container-runtime=docker 来快速启动 minikube\nminikube Cheatsheet\nminikube stop 不会删除任何数据，只是停止 VM 和 k8s 集群。\nminikube delete 删除所有 minikube 启动后的数据。\nminikube ip 集群和 docker enginer 运行的 IP 地址。\nminikube pause 暂停当前的资源和集群\nminikube status 查看当前集群状态\n安装 k8s CLI 和 Terminal based UI 如果本地没有k8s CLI kubectl 的话，需要安装一下\nbrew install kubectl 如果我们希望更直观的观察 kubenates 中资源的变化，也可以安装一个 k9s（对于初学者而言，更建议使用 kubectl 来手动观察）\nbrew install k9s 如果需要练习 helm 的使用，可以先安装 helm\nbrew install helm 注册 docker hub 账号登录 在 docker hun(https://hub.docker.com/) 中注册账号，并且使用 login 登录账号。\ndocker login Container # app.rb require \"sinatra\" set :bind, \"0.0.0.0\" get \"*\" do \"[v1] Hello, Kubernetes!\\n\" end # Dockerfile FROM ruby:2.6.1-alpine3.9 RUN apk add curl \u0026\u0026 gem install sinatra COPY app.rb . ENTRYPOINT [\"ruby\", \"app.rb\"] docker build . -t guangzhengli/hellok8s:v1 docker run -p 4567:4567 --name hellok8s -d guangzhengli/hellok8s:v1 docker push guangzhengli/hellok8s:v1 Pod # nginx.yaml apiVersion: v1 kind: Pod metadata: name: nginx spec: containers: - name: nginx-container image: nginx kubectl apply -f nginx.yaml kubectl port-forward nginx 3001:80 kubectl logs --follow nginx ^ ^ | | ------------- tells kubectl to keep | streaming the logs live, | instead of just | printing and exiting | ---- the name of the pod we want to see the logs kubectl exec nginx -- ls root@nginx:/ echo \"it works!\" \u003e /usr/share/nginx/html/index.html kubectl delete pod nginx # pod \"nginx\" deleted kubectl delete -f nginx.yaml # pod \"nginx\" deleted apiVersion: v1 kind: Pod metadata: name: httpd spec: containers: - name: httpd-container image: registry.hub.docker.com/library/httpd # default page in: /usr/local/apache2/htdocs/index.html # hellok8s.yaml apiVersion: v1 kind: Pod metadata: name: hellok8s spec: containers: - name: hellok8s-container image: guangzhengli/hellok8s:v1 kubectl port-forward hellok8s 4567:4567 Deployment # deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 1 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v1 name: hellok8s-container kubectl apply -f deployment.yaml kubectl get pods # NAME READY STATUS RESTARTS # hellok8s-6678f66cb8-42jtr 1/1 Running 0 # Replace the pod name with your local pod name kubectl delete pod hellok8s-6678f66cb8-42jtr # pod \"hellok8s-6678f66cb8-42jtr\" deleted kubectl get pods # NAME READY STATUS RESTARTS # hellok8s-6678f66cb8-8nqf2 1/1 Running 0 # deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 10 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v1 name: hellok8s-container release new verison get \"*\" do \"[v2] Hello, Kubernetes!\\n\" end docker build . -t guangzhengli/hellok8s:v2 docker push guangzhengli/hellok8s:v2 apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v2 name: hellok8s-container kubectl get pods # NAME READY STATUS # hellok8s-6678f66cb8-52zt9 1/1 Running # hellok8s-6678f66cb8-nxphs 1/1 Running # You can locally run the port forward command by replacing the pod name kubectl port-forward hellok8s-6678f66cb8-52zt9 4567:4567 # or open another terminal and run the followig command curl http://localhost:4567 # [v2] Hello, Kubernetes! Rolling Update apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 1 replicas: 3 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v2 name: hellok8s-container require \"sinatra\" set :bind, \"0.0.0.0\" $counter = 0 get \"*\" do $counter += 1 if $counter \u003e 3 raise \"Whoops, something is wrong\" end \"[bad] Hello, Kubernetes!\\n\" end docker build . -t guangzhengli/hellok8s:bad docker push guangzhengli/hellok8s:bad apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:bad name: hellok8s-container kubectl rollout history deployment hellok8s kubectl rollout undo deployment hellok8s kubectl rollout undo deployment/hellok8s --to-revision=2 Automatically blocking bad releases by readinessProbe apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v2 # Still using v2 name: hellok8s-container readinessProbe: # New readiness probe periodSeconds: 1 successThreshold: 5 httpGet: path: / port: 4567 kubectl describe pod hellok8s-68f47f657c-zwn6g # ... # ... # ... # Readiness probe failed: # HTTP probe failed with statuscode: 500 Service # service.yaml apiVersion: v1 kind: Service metadata: name: hellok8s-svc spec: type: NodePort selector: app: hellok8s ports: - port: 4567 nodePort: 30001 kubectl apply -f service.yaml apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v3 name: hellok8s-container kubectl get service hellok8s-svc #app.rb require \"sinatra\" set :bind, \"0.0.0.0\" get \"*\" do \"[v3] Hello, Kubernetes, from #{`hostname`.strip}!\\n\" end docker build . -t guangzhengli/hellok8s:v3 docker push guangzhengli/hellok8s:v3 kubectl apply -f deployment.yaml curl http://localhost:30001 # [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-t9ngx! curl http://localhost:30001 # [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-985dq! curl http://localhost:30001 # [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-t9ngx! ingress minikube addons enable ingress kubectl delete deployment,service --all apiVersion: v1 kind: Service metadata: name: hellok8s-svc spec: selector: app: hellok8s ports: - port: 4567 targetPort: 4567 --- apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v3 name: hellok8s-container # nginx.yaml apiVersion: v1 kind: Service metadata: name: nginx-svc spec: selector: app: nginx ports: - port: 1234 targetPort: 80 --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - image: nginx name: nginx-container kubectl apply -f hellok8s.yaml # service/hellok8s-svc created # deployment.apps/hellok8s created kubectl apply -f nginx.yaml # service/nginx-svc created # deployment.apps/nginx created kubectl get pods # NAME READY STATUS RESTARTS # hellok8s-7f4c57d446-6c8b8 1/1 Running 0 # hellok8s-7f4c57d446-jkqbl 1/1 Running 0 # nginx-77c5c66899-dgkk2 1/1 Running 0 # nginx-77c5c66899-w9srw 1/1 Running 0 kubectl get service # NAME TYPE CLUSTER-IP PORT(S) # hellok8s-svc ClusterIP 10.102.242.233 4567/TCP # nginx-svc ClusterIP 10.96.19.78 1234/TCP apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: hello-ingress annotations: # We are defining this annotation to prevent nginx # from redirecting requests to `https` for now nginx.ingress.kubernetes.io/ssl-redirect: \"false\" spec: rules: - http: paths: - path: / pathType: Prefix backend: service: name: nginx-svc port: number: 1234 - path: /hello pathType: Prefix backend: service: name: hellok8s-svc port: number: 4567 kubectl apply -f ingress.yaml # ingress.extensions/hello-ingress created kubectl get ingress # NAME HOSTS ADDRESS PORTS AGE # hello-ingress * localhost 80 1m kubectl apply -f ingress.yaml # ingress.extensions/hello-ingress configured curl http://localhost/hello # [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-qth54! curl http://localhost # (nginx welcome page) Configmap env var require \"sinatra\" set :bind, \"0.0.0.0\" get \"*\" do message = ENV.fetch(\"MESSAGE\", \"Hello, Kubernetes\") \"[v4] #{message} (from #{`hostname`.strip})\\n\" end docker build . -t guangzhengli/hellok8s:v4 docker push guangzhengli/hellok8s:v4 kubectl delete deployment,service,ingress --all apiVersion: v1 kind: Service metadata: name: hellok8s-svc spec: type: NodePort selector: app: hellok8s ports: - port: 4567 nodePort: 30001 --- apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v4 name: hellok8s-container kubectl apply -f hellok8s.yaml curl localhost:30001 # [v4] Hello, Kubernetes (from hellok8s-69dbd44879-vt8dv) apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v4 name: hellok8s-container env: - name: MESSAGE value: \"It works!\" kubectl apply -f hellok8s.yaml curl localhost:30001 # [v4] It works! (from hellok8s-568f64dd94-bfxhs) configmap # hellok8s-config.yaml apiVersion: v1 kind: ConfigMap metadata: name: hellok8s-config data: MESSAGE: \"It works with a ConfigMap!\" apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v4 name: hellok8s-container env: - name: MESSAGE valueFrom: configMapKeyRef: name: hellok8s-config key: MESSAGE kubectl apply -f hellok8s-config.yaml kubectl apply -f hellok8s.yaml kubectl apply -f service.yaml curl localhost:30001 # [v4] It works with a ConfigMap! (from hellok8s-54d5fb5765-nl62z) Getting all the variables from a ConfigMap env: - name: VAR1 valueFrom: configMapKeyRef: name: hellok8s-config key: VAR1 - name: VAR2 valueFrom: configMapKeyRef: name: hellok8s-config key: VAR2 - name: VAR3 valueFrom: configMapKeyRef: name: hellok8s-config key: VAR3 # ... apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v4 name: hellok8s-container envFrom: - configMapRef: name: hellok8s-config kubectl apply -f hellok8s-updated.yaml curl localhost:30001 # [v4] It works with a ConfigMap! (from hellok8s-54d5fb5765-nl62z) Exposing ConfigMap as files apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: volumes: - name: config configMap: name: hellok8s-config containers: - image: guangzhengli/hellok8s:v4 name: hellok8s-container volumeMounts: - name: config mountPath: /config kubectl apply -f hellok8s.yaml kubectl apply -f hellok8s-config.yaml kubectl get pods # NAME READY STATUS # hellok8s-8c56675c9-7gxpv 1/1 Running # hellok8s-8c56675c9-bfk8t 1/1 Running # Replace the pod name to what you have running locally kubectl exec -it hellok8s-8c56675c9-7gxpv -- sh cat /config/MESSAGE # It works with a ConfigMap! Secret # hellok8s-secret.yaml apiVersion: v1 kind: Secret metadata: name: hellok8s-secret data: SECRET_MESSAGE: \"SXQgd29ya3Mgd2l0aCBhIFNlY3JldAo=\" echo 'It works with a Secret' | base64 # SXQgd29ya3Mgd2l0aCBhIFNlY3JldAo= apiVersion: apps/v1 kind: Deployment metadata: name: hellok8s spec: replicas: 2 selector: matchLabels: app: hellok8s template: metadata: labels: app: hellok8s spec: containers: - image: guangzhengli/hellok8s:v4 name: hellok8s-container env: - name: MESSAGE valueFrom: secretKeyRef: name: hellok8s-secret key: SECRET_MESSAGE kubectl apply -f hellok8s-secret.yaml kubectl apply -f deployment.yaml kubectl get pods # NAME READY STATUS # hellok8s-6d7579848d-f56wb 1/1 Running # hellok8s-6d7579848d-kzq57 1/1 Running # Replace the pod name to what you have running locally kubectl exec -it hellok8s-6d7579848d-kzq57 -- env | grep MESSAGE # MESSAGE=It works with a Secret Using stringData apiVersion: v1 kind: Secret metadata: name: hellok8s-secret stringData: SECRET_MESSAGE: \"It works with a Secret\" kubectl get secret hellok8s-secret -o yaml # apiVersion: v1 # kind: Secret # data: # SECRET_MESSAGE: SXQgd29ya3Mgd2l0aCBhIFNlY3JldAo= # ... helm helm create helm-hello helm upgrade --install hello-helm --values values.yaml . helm list helm rollback hello-helm ","wordCount":"1699","inLanguage":"zh","datePublished":"2021-07-18T20:29:08Z","dateModified":"2021-07-18T20:29:08Z","author":{"@type":"Person","name":"iguangzhengli@gmail.com"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://guangzhengli.github.io/zh/blog/kubenates-workshop/"},"publisher":{"@type":"Organization","name":"LADDER","logo":{"@type":"ImageObject","url":"https://guangzhengli.github.io/favicon.ico"}}}</script><link rel=icon type=image/png href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=/css/main.min.094482593009f58438ff5c485fe3255863b70f1996e1037c599842db0cc816b3.css integrity="sha256-CUSCWTAJ9YQ4/1xIX+MlWGO3DxmW4QN8WZhC2wzIFrM=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.698bc9ccb8ccaf7f58dc58847b72072cc4b88774110168045d5299bbaee4b1ca.js></script>
<script>hljs.highlightAll()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/zh>LADDER</a><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/zh/blog>文章</a></li><li class=navigation-item><a class=navigation-link href=/zh/tags>分类</a></li><li class=navigation-item><a class=navigation-link href=/zh/archives>历史文章</a></li></ul><div class=navigation-right><ul class=navigation-social><li class=navigation-item><a class=navigation-link href=https://github.com/guangzhengli><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class=navigation-item><a class=navigation-link href=https://twitter.com/iguangzhengli><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li></ul><button id=mode class="dark btn-link" type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><li class=language-item><a href=https://guangzhengli.github.io/blog/kubenates-workshop/>EN</a></li></div></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Kubenates workshop</h1></header><p><small>2021年7月18日&nbsp;· 1699 字&nbsp;· 8 分钟</small>
<small>·
<a href=https://guangzhengli.github.io/zh/tags/cloudnative/>CloudNative</a>
<a href=https://guangzhengli.github.io/zh/tags/kubenates/>kubenates</a>
<a href=https://guangzhengli.github.io/zh/tags/container/>container</a>
<a href=https://guangzhengli.github.io/zh/tags/helm/>helm</a></small><p><div class=blog-toc><nav id=TableOfContents><ul><li><ul><li><a href=#安装-docker>安装 docker</a></li><li><a href=#安装-minikube>安装 minikube</a></li><li><a href=#安装-k8s-cli-和-terminal-based-ui>安装 k8s CLI 和 Terminal based UI</a></li><li><a href=#注册-docker-hub-账号登录>注册 docker hub 账号登录</a></li></ul></li><li><a href=#container>Container</a></li><li><a href=#pod>Pod</a></li><li><a href=#deployment>Deployment</a><ul><li><a href=#release-new-verison>release new verison</a></li><li><a href=#rolling-update>Rolling Update</a></li><li><a href=#automatically-blocking-bad-releases-by-readinessprobe>Automatically blocking bad releases by readinessProbe</a></li></ul></li><li><a href=#service>Service</a></li><li><a href=#ingress>ingress</a></li><li><a href=#configmap>Configmap</a><ul><li><a href=#env-var>env var</a></li><li><a href=#configmap-1>configmap</a></li><li><a href=#getting-all-the-variables-from-a-configmap>Getting all the variables from a ConfigMap</a></li><li><a href=#exposing-configmap-as-files>Exposing ConfigMap as files</a></li></ul></li><li><a href=#secret>Secret</a><ul><li><a href=#using-stringdata>Using stringData</a></li></ul></li><li><a href=#helm>helm</a></li></ul></nav></div><section class=blog-content><p>本文关于 kubenates workshop
<img src=https://cdn.jsdelivr.net/gh/guangzhengli/PicURL@master/uPic/7Opaig.png alt=7Opaig></p><h1 id=准备工作>准备工作</h1><p>本地环境是 MacOS 11.6.2 Intel 版本，教程也是本地环境。windows 或 linux 环境的小伙伴需要自行安装 docker 和 minikube。</p><p><img src=https://cdn.jsdelivr.net/gh/guangzhengli/PicURL@master/uPic/7Opaig.png alt=7Opaig></p><h3 id=安装-docker>安装 docker</h3><p>因为 docker desktop 各种协议和法律问题，已经不建议大家直接安装 desktop 使用，建议只安装 CLI。注意：如果本地已经安装了 docker desktop，那么可以忽略这一步，下一步也可以简化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Install Docker CLI</span>
</span></span><span style=display:flex><span>brew install docker
</span></span><span style=display:flex><span>brew install docker-compose
</span></span></code></pre></div><h3 id=安装-minikube>安装 minikube</h3><p><a href=https://minikube.sigs.k8s.io/docs/>minikube</a> 用于在本地环境中运行 Kubernetes 集群。但它也运行一个可用于运行容器的 docker 守护进程。在 macOS 上，minikube 运行在很多虚拟化技术上，可以选择<a href=https://minikube.sigs.k8s.io/docs/drivers/hyperkit/>hyperkit</a>，这里因为我本地之前已经安装过 virtualbox (brew install &ndash;cask virtualbox)，所以我用的是 virtualbox 虚拟化技术。如果你本地之前已经安装了 docker desktop 的话，可以不需要下载 <code>hyperkit</code> 或者 <code>virtualbox</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Install hyperkit and minikube (check which vm-driver to use, if install docker desktop already, you can just use vm-driver=docker instead of install hyperkiy)</span>
</span></span><span style=display:flex><span>brew install hyperkit
</span></span><span style=display:flex><span>brew install minikube
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/guangzhengli/PicURL@master/uPic/7Opaig.png alt=7Opaig></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Start minikube </span>
</span></span><span style=display:flex><span>minikube start --vm-driver hyperkit --container-runtime<span style=color:#f92672>=</span>docker
</span></span><span style=display:flex><span><span style=color:#75715e># minikube start --vm-driver virtualbox --container-runtime=docker</span>
</span></span><span style=display:flex><span><span style=color:#75715e># minikube start --vm-driver docker --container-runtime=docker</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Tell Docker CLI to talk to minikube&#39;s VM</span>
</span></span><span style=display:flex><span>eval <span style=color:#66d9ef>$(</span>minikube docker-env<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Save IP to a hostname</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;`minikube ip` docker.local&#34;</span> | sudo tee -a /etc/hosts &gt; /dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Test</span>
</span></span><span style=display:flex><span>docker run hello-world
</span></span></code></pre></div><blockquote><p>注意：如果本地已经安装了 docker desktop，那么可以使用 minikube start &ndash;vm-driver docker &ndash;container-runtime=docker 来快速启动 minikube</p></blockquote><p><strong>minikube Cheatsheet</strong></p><p><code>minikube stop</code> 不会删除任何数据，只是停止 VM 和 k8s 集群。</p><p><code>minikube delete</code> 删除所有 minikube 启动后的数据。</p><p><code>minikube ip</code> 集群和 docker enginer 运行的 IP 地址。</p><p><code>minikube pause</code> 暂停当前的资源和集群</p><p><code>minikube status</code> 查看当前集群状态</p><h3 id=安装-k8s-cli-和-terminal-based-ui>安装 k8s CLI 和 Terminal based UI</h3><p>如果本地没有k8s CLI <code>kubectl</code> 的话，需要安装一下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install kubectl
</span></span></code></pre></div><p>如果我们希望更直观的观察 kubenates 中资源的变化，也可以安装一个 <a href=https://k9scli.io/>k9s</a>（对于初学者而言，更建议使用 kubectl 来手动观察）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install k9s
</span></span></code></pre></div><p>如果需要练习 helm 的使用，可以先安装 helm</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install helm
</span></span></code></pre></div><h3 id=注册-docker-hub-账号登录>注册 docker hub 账号登录</h3><p>在 docker hun(<a href=https://hub.docker.com/>https://hub.docker.com/</a>) 中注册账号，并且使用 login 登录账号。</p><pre tabindex=0><code>docker login
</code></pre><h2 id=container>Container</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># app.rb</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#34;sinatra&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set <span style=color:#e6db74>:bind</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>get <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;[v1] Hello, Kubernetes!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ruby:2.6.1-alpine3.9</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add curl <span style=color:#f92672>&amp;&amp;</span> gem install sinatra<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> app.rb .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;ruby&#34;</span>, <span style=color:#e6db74>&#34;app.rb&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build . -t guangzhengli/hellok8s:v1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -p 4567:4567 --name hellok8s -d guangzhengli/hellok8s:v1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker push guangzhengli/hellok8s:v1
</span></span></code></pre></div><h2 id=pod>Pod</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># nginx.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f nginx.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl port-forward nginx 3001:80
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl logs --follow nginx
</span></span><span style=display:flex><span>               ^        ^
</span></span><span style=display:flex><span>               |        |
</span></span><span style=display:flex><span>                ------------- tells kubectl to keep
</span></span><span style=display:flex><span>                        |     streaming the logs live,
</span></span><span style=display:flex><span>                        |     instead of just
</span></span><span style=display:flex><span>                        |     printing and exiting
</span></span><span style=display:flex><span>                        |
</span></span><span style=display:flex><span>                         ---- the name of the pod we want
</span></span><span style=display:flex><span>                              to see the logs
</span></span><span style=display:flex><span>                              
</span></span><span style=display:flex><span>kubectl exec nginx -- ls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@nginx:/ echo <span style=color:#e6db74>&#34;it works!&#34;</span> &gt; /usr/share/nginx/html/index.html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl delete pod nginx
</span></span><span style=display:flex><span><span style=color:#75715e># pod &#34;nginx&#34; deleted</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl delete -f nginx.yaml
</span></span><span style=display:flex><span><span style=color:#75715e># pod &#34;nginx&#34; deleted</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd-container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.hub.docker.com/library/httpd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># default page in: /usr/local/apache2/htdocs/index.html</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># hellok8s.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v1</span>
</span></span></code></pre></div><pre tabindex=0><code>kubectl port-forward hellok8s 4567:4567
</code></pre><h2 id=deployment>Deployment</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># deployment.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f deployment.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods       
</span></span><span style=display:flex><span><span style=color:#75715e># NAME                        READY   STATUS    RESTARTS</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-6678f66cb8-42jtr   1/1     Running   0       </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Replace the pod name with your local pod name</span>
</span></span><span style=display:flex><span>kubectl delete pod hellok8s-6678f66cb8-42jtr
</span></span><span style=display:flex><span><span style=color:#75715e># pod &#34;hellok8s-6678f66cb8-42jtr&#34; deleted</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span><span style=color:#75715e># NAME                        READY   STATUS    RESTARTS  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-6678f66cb8-8nqf2   1/1     Running   0</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># deployment.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><h3 id=release-new-verison>release new verison</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>get <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;[v2] Hello, Kubernetes!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build . -t guangzhengli/hellok8s:v2
</span></span><span style=display:flex><span>docker push guangzhengli/hellok8s:v2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span><span style=color:#75715e># NAME                        READY   STATUS</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-6678f66cb8-52zt9   1/1     Running</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-6678f66cb8-nxphs   1/1     Running</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># You can locally run the port forward command by replacing the pod name</span>
</span></span><span style=display:flex><span>kubectl port-forward hellok8s-6678f66cb8-52zt9 4567:4567
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># or open another terminal and run the followig command</span>
</span></span><span style=display:flex><span>curl http://localhost:4567
</span></span><span style=display:flex><span><span style=color:#75715e># [v2] Hello, Kubernetes!</span>
</span></span></code></pre></div><h3 id=rolling-update>Rolling Update</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>rollingUpdate</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>maxSurge</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>maxUnavailable</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#34;sinatra&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set <span style=color:#e6db74>:bind</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>get <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  $counter <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> $counter <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#e6db74>&#34;Whoops, something is wrong&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;[bad] Hello, Kubernetes!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><pre tabindex=0><code>docker build . -t guangzhengli/hellok8s:bad
docker push guangzhengli/hellok8s:bad
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:bad</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout history deployment hellok8s
</span></span><span style=display:flex><span>kubectl rollout undo deployment hellok8s
</span></span><span style=display:flex><span>kubectl rollout undo deployment/hellok8s --to-revision<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>
</span></span></code></pre></div><h3 id=automatically-blocking-bad-releases-by-readinessprobe>Automatically blocking bad releases by readinessProbe</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v2</span> <span style=color:#75715e># Still using v2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>readinessProbe</span>: <span style=color:#75715e># New readiness probe</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>successThreshold</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>: <span style=color:#ae81ff>4567</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod hellok8s-68f47f657c-zwn6g
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Readiness probe failed:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># HTTP probe failed with statuscode: 500</span>
</span></span></code></pre></div><h2 id=service>Service</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># service.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-svc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>4567</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30001</span>
</span></span></code></pre></div><pre tabindex=0><code>kubectl apply -f service.yaml
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><pre tabindex=0><code>kubectl get service hellok8s-svc
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>#app.rb</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#34;sinatra&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set <span style=color:#e6db74>:bind</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>get <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;[v3] Hello, Kubernetes, from </span><span style=color:#e6db74>#{</span><span style=color:#e6db74>`hostname`</span><span style=color:#f92672>.</span>strip<span style=color:#e6db74>}</span><span style=color:#e6db74>!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><pre tabindex=0><code>docker build . -t guangzhengli/hellok8s:v3
docker push guangzhengli/hellok8s:v3
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f deployment.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:30001
</span></span><span style=display:flex><span><span style=color:#75715e># [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-t9ngx!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:30001
</span></span><span style=display:flex><span><span style=color:#75715e># [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-985dq!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:30001
</span></span><span style=display:flex><span><span style=color:#75715e># [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-t9ngx!</span>
</span></span></code></pre></div><h2 id=ingress>ingress</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube addons enable ingress
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl delete deployment,service --all
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-svc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>4567</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>4567</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># nginx.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-svc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>1234</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-container</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f hellok8s.yaml
</span></span><span style=display:flex><span><span style=color:#75715e># service/hellok8s-svc created</span>
</span></span><span style=display:flex><span><span style=color:#75715e># deployment.apps/hellok8s created</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f nginx.yaml
</span></span><span style=display:flex><span><span style=color:#75715e># service/nginx-svc created</span>
</span></span><span style=display:flex><span><span style=color:#75715e># deployment.apps/nginx created</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span><span style=color:#75715e># NAME                        READY   STATUS    RESTARTS </span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-7f4c57d446-6c8b8   1/1     Running   0        </span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-7f4c57d446-jkqbl   1/1     Running   0        </span>
</span></span><span style=display:flex><span><span style=color:#75715e># nginx-77c5c66899-dgkk2      1/1     Running   0        </span>
</span></span><span style=display:flex><span><span style=color:#75715e># nginx-77c5c66899-w9srw      1/1     Running   0        </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get service
</span></span><span style=display:flex><span><span style=color:#75715e># NAME           TYPE        CLUSTER-IP       PORT(S)   </span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-svc   ClusterIP   10.102.242.233   4567/TCP  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># nginx-svc      ClusterIP   10.96.19.78      1234/TCP</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hello-ingress</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># We are defining this annotation to prevent nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># from redirecting requests to `https` for now</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/ssl-redirect</span>: <span style=color:#e6db74>&#34;false&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>pathType</span>: <span style=color:#ae81ff>Prefix</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-svc</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>number</span>: <span style=color:#ae81ff>1234</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/hello</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>pathType</span>: <span style=color:#ae81ff>Prefix</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-svc</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>number</span>: <span style=color:#ae81ff>4567</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ingress.yaml
</span></span><span style=display:flex><span><span style=color:#75715e># ingress.extensions/hello-ingress created</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get ingress
</span></span><span style=display:flex><span><span style=color:#75715e># NAME            HOSTS   ADDRESS     PORTS   AGE</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hello-ingress   *       localhost   80      1m</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ingress.yaml
</span></span><span style=display:flex><span><span style=color:#75715e># ingress.extensions/hello-ingress configured</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost/hello
</span></span><span style=display:flex><span><span style=color:#75715e># [v3] Hello, Kubernetes, from hellok8s-7f4c57d446-qth54!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost
</span></span><span style=display:flex><span><span style=color:#75715e># (nginx welcome page)</span>
</span></span></code></pre></div><h2 id=configmap>Configmap</h2><h3 id=env-var>env var</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#34;sinatra&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set <span style=color:#e6db74>:bind</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>get <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  message <span style=color:#f92672>=</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>.</span>fetch(<span style=color:#e6db74>&#34;MESSAGE&#34;</span>, <span style=color:#e6db74>&#34;Hello, Kubernetes&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;[v4] </span><span style=color:#e6db74>#{</span>message<span style=color:#e6db74>}</span><span style=color:#e6db74> (from </span><span style=color:#e6db74>#{</span><span style=color:#e6db74>`hostname`</span><span style=color:#f92672>.</span>strip<span style=color:#e6db74>}</span><span style=color:#e6db74>)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><pre tabindex=0><code>docker build . -t guangzhengli/hellok8s:v4
docker push guangzhengli/hellok8s:v4

kubectl delete deployment,service,ingress --all
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-svc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>4567</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30001</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f hellok8s.yaml 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl localhost:30001
</span></span><span style=display:flex><span><span style=color:#75715e># [v4] Hello, Kubernetes (from hellok8s-69dbd44879-vt8dv)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>MESSAGE</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;It works!&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f hellok8s.yaml 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl localhost:30001
</span></span><span style=display:flex><span><span style=color:#75715e># [v4] It works! (from hellok8s-568f64dd94-bfxhs)</span>
</span></span></code></pre></div><h3 id=configmap-1>configmap</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># hellok8s-config.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>MESSAGE</span>: <span style=color:#e6db74>&#34;It works with a ConfigMap!&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>MESSAGE</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>configMapKeyRef</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-config</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>key</span>: <span style=color:#ae81ff>MESSAGE</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f hellok8s-config.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f hellok8s.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f service.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl localhost:30001
</span></span><span style=display:flex><span><span style=color:#75715e># [v4] It works with a ConfigMap! (from hellok8s-54d5fb5765-nl62z)</span>
</span></span></code></pre></div><h3 id=getting-all-the-variables-from-a-configmap>Getting all the variables from a ConfigMap</h3><pre tabindex=0><code>env:
  - name: VAR1
    valueFrom:
      configMapKeyRef:
        name: hellok8s-config
        key: VAR1

  - name: VAR2
    valueFrom:
      configMapKeyRef:
        name: hellok8s-config
        key: VAR2

  - name: VAR3
    valueFrom:
      configMapKeyRef:
        name: hellok8s-config
        key: VAR3
# ...
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>envFrom</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>configMapRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-config</span>
</span></span></code></pre></div><pre tabindex=0><code>kubectl apply -f hellok8s-updated.yaml

curl localhost:30001
# [v4] It works with a ConfigMap! (from hellok8s-54d5fb5765-nl62z)
</code></pre><h3 id=exposing-configmap-as-files>Exposing ConfigMap as files</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>       - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>           <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-config</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/config</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f hellok8s.yaml
</span></span><span style=display:flex><span>kubectl apply -f hellok8s-config.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span><span style=color:#75715e># NAME                       READY   STATUS</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-8c56675c9-7gxpv   1/1     Running</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-8c56675c9-bfk8t   1/1     Running</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Replace the pod name to what you have running locally</span>
</span></span><span style=display:flex><span>kubectl exec -it hellok8s-8c56675c9-7gxpv -- sh
</span></span><span style=display:flex><span>cat /config/MESSAGE
</span></span><span style=display:flex><span><span style=color:#75715e># It works with a ConfigMap!</span>
</span></span></code></pre></div><h2 id=secret>Secret</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># hellok8s-secret.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>SECRET_MESSAGE</span>: <span style=color:#e6db74>&#34;SXQgd29ya3Mgd2l0aCBhIFNlY3JldAo=&#34;</span>
</span></span></code></pre></div><pre tabindex=0><code>echo &#39;It works with a Secret&#39; | base64
# SXQgd29ya3Mgd2l0aCBhIFNlY3JldAo=
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hellok8s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>guangzhengli/hellok8s:v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>MESSAGE</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>secretKeyRef</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-secret</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>key</span>: <span style=color:#ae81ff>SECRET_MESSAGE</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f hellok8s-secret.yaml
</span></span><span style=display:flex><span>kubectl apply -f deployment.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span><span style=color:#75715e># NAME                        READY   STATUS</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-6d7579848d-f56wb   1/1     Running</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hellok8s-6d7579848d-kzq57   1/1     Running</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Replace the pod name to what you have running locally</span>
</span></span><span style=display:flex><span>kubectl exec -it hellok8s-6d7579848d-kzq57 --  env | grep MESSAGE
</span></span><span style=display:flex><span><span style=color:#75715e># MESSAGE=It works with a Secret</span>
</span></span></code></pre></div><h3 id=using-stringdata>Using stringData</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hellok8s-secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>stringData</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>SECRET_MESSAGE</span>: <span style=color:#e6db74>&#34;It works with a Secret&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret hellok8s-secret -o yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># apiVersion: v1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># kind: Secret</span>
</span></span><span style=display:flex><span><span style=color:#75715e># data:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   SECRET_MESSAGE: SXQgd29ya3Mgd2l0aCBhIFNlY3JldAo=</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div><h2 id=helm>helm</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm create helm-hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm upgrade --install hello-helm --values values.yaml .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm rollback hello-helm
</span></span></code></pre></div></section><div class=paginator><a class=prev href=https://guangzhengli.github.io/zh/blog/categories/><span>&larr;&nbsp;&nbsp;</span><span>Categories</span></a>
<a class=next href=https://guangzhengli.github.io/zh/blog/code-highlight/><span>Code Highlight Style test</span><span>&nbsp;&nbsp;&rarr;</span></a></div></article><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","guangzhengli/blog-comments"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></div><footer class=footer><p>&copy; 2022 <a href=https://guangzhengli.github.io/>LADDER</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>